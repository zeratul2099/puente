{% extends "basis.html" %}

{% block titel %}P&uuml;nte Schuldenliste{% endblock %}

{% block inhalt %}
<div id="content_container">

<script>
        var buy = function(name, price, pos) {
            var customer = name
            var ajax = "yes";
            
                
            if (customer != "" && price != "") {
                if (pos == true) {
                    var data = { customer:customer, buy:price, ajax:ajax };
                    var args = { type:"POST", url:".", data:data, complete:done };
                    $.ajax(args);
                } else {
                    var data = { customer:customer, pay:"true", money:price, ajax:ajax };
                    var args = { type:"POST", url:".", data:data, complete:done };
                    $.ajax(args);
                }
            }
            else {


            }
            return false;
            };
            
            var done = function(res, status) {
              if (status == "success") {

                var data = JSON.parse(res.responseText);
                if (data['status'] == '0' ) {
                    $("#buyrow"+data['id']+" > * > * > input[type='submit']").attr("disabled", false);
                    var newDepts = $("<td id='depts"+data['id']+"'><b>"+data['depts']+' &euro;</b></td>');
                } else {
                    $("#buyrow"+data['id']+" > * > * > input[type='submit']").attr("disabled", false);
                    var newDepts = $("<td id='depts"+data['id']+"'><b><font color='red'>"+data['depts']+' &euro;</font></b></td>');
                }
                if (data['status'] == '2' ) {
                    $("#buyrow"+data['id']+" > * > * > input[type='submit']").attr("disabled", true);
                }
                var newLastPaid = $("<td id='lastPaid"+data['id']+"' >"+data['lastPaid']+"</td>")
                if (data['depts'] == '0.0' || data['depts'] == '0') {
                    $("#del"+data['id']).attr("disabled", false);
                } else {
                    $("#del"+data['id']).attr("disabled", true);
                }
                $("#unname").attr("value", data['unname']);
                $("#unmoney").attr("value", data['unmoney']);
                $("#undo").attr("value", "Rückgängig: "+data['unname']+" - "+data['unmoney']);
                $("#depts"+data['id']).replaceWith(newDepts);
                $("#lastPaid"+data['id']).replaceWith(newLastPaid);
                
                $("#ptSum").replaceWith("<b id='ptSum' >"+data['ptSum']+"</b>");
                $("#ptSales").replaceWith("<b id='ptSales' >"+data['ptSales']+"</b>");
                $("#cSum").replaceWith("<b id='cSum' >"+data['cSum']+"</b>");
                $("#cSales").replaceWith("<b id='cSales' >"+data['cSales']+"</b>");
              }
              else {
                var elem = $('#row'+data['id']);
                var msg_div = $('<tr><td colspan="6" ><font color="red"><p>No connection to server</p></font></td></tr>');
                msg_div.insertAfter(elem).fadeIn('slow').animate({opacity: 1.0}, 5000).fadeOut('slow',function() { msg_div.remove(); });
              }
            };
</script>



<font color='red' id='error' >{{ error }}</font>
<div class='leftspace'>
<form method='post' action='.'>
    <input type='hidden' name='customer' value='{{ unname }}' id='unname' />
    <input type='hidden' name='unmoney' value='{{ unmoney }}' id='unmoney' />
    <input type='submit' name='undo' value='R&uuml;ckg&auml;ngig: {{ unname }} - {{ unmoney }}' id='undo'
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
</form>
<h3>P&uuml;ntenteam ({{ pmen|length }})</h3>
</div>
<div id="content">
<table width='100%'>
<tr>
    <td>Name</td>
    <td>Schulden</td>
    <td>kaufen</td>
    <td>bezahlen</td>
    <td>zuletzt bezahlt</td>
</tr>
<tr>
<td colspan='6'><hr></td>
</tr>
{% for pt in pmen %}
    {% if forloop.counter|divisibleby:"2" %}
    <tr id='row{{ pt.id }}'>
    {% else %}
    <tr class='darkbackground' id='row{{ pt.id }}' >
    {% endif %}

        <td> <a href='{{ pt.id }}'>{{ pt.name }}</a></td>
        <td id="depts{{ pt.id }}">
         {% ifequal pt.dept_status 0 %} 
        <b>{{ pt.depts }} &euro;</b>
        {% else %}
        <b><font color='red'>{{ pt.depts }} &euro;</font></b>
        {% endifequal %}
        </td>
        <td>
        <table>
            <tr id='buyrow{{ pt.id }}' >
        {% for p in pprices %}
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ pt.name }}' id='customer{{ pt.id }}_{{ p }}' />
            <input type='hidden' name='buy' value='{{ p }}' id='buy{{ pt.id }}_{{ p }}' />
            <input type='submit' name='{{ p }}' id='buybtn{{ pt.id }}_{{ p }}' value='{{ p }} ct' {% ifequal pt.dept_status 2 %} disabled=true {% endifequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
        <script>
         $("#buybtn{{ pt.id }}_{{ p }}").click(function() {
             buy("{{ pt.name }}", "{{ p }}", true);
             return false;
             });  
        </script>
        {% endfor %}
              </tr>
        </table>
        <td><form method='post' action='.'>
            <input type='text' name='money' id='paymoney{{ pt.id }}' />
            <input type='hidden' name='customer' value='{{ pt.name }}' />
            <input type='submit' name='pay' value='bezahlen' id='paybtn{{ pt.id }}'
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
  <!--       <script>
        $("#paybtn{{ pt.id }}").click(function() {
             buy("{{ pt.name }}", $("#paymoney{{ pt.id }}").val(), false);
             $("#paymoney{{ pt.id }}").attr("value", "");
             return false;
             });  
        </script>-->
        </td>
        <td id='lastPaid{{ pt.id }}' > {{ pt.lastPaid.date|date:"D, d.M. Y" }}</td>
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ pt.name }}' />
            <input type='submit' name='delete' value='delete' id='del{{ pt.id }}' {% ifnotequal pt.depts 0 %}disabled=true{% endifnotequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
    </tr>   
    
{% endfor %}
<tr>
<td colspan='6'><hr></td>
</tr>
<tr><td>
Summe
</td><td>
<b id='ptSum' >{{sum.3 }}</b>
</td>
</tr>
<tr><td>
Wochenumsatz
</td><td>
<b id='ptSales' >{{sum.2 }}</b>
</td>
</tr>

</table>
</div>


<div class='leftspace'><h3>G&auml;ste ({{ customer|length }})</h3></div>
<div id="content">
<table width='100%'>
<tr>
    <td>Name</td>
    <td>Schulden</td>
    <td>kaufen</td>
    <td>bezahlen</td>
    <td>zuletzt bezahlt</td>
</tr>
<tr>
<td colspan='6'><hr></td>
</tr>
{% for c in customer %}
    {% if forloop.counter|divisibleby:"2" %}
    <tr id='row{{ c.id }}'>
    {% else %}
    <tr class='darkbackground' id='row{{ c.id }}' >
    {% endif %}
        <td><a href='{{ c.id }}'>{{ c.name }}</a></td>
        <td id="depts{{ c.id }}" >
        {% ifequal c.dept_status 0 %} 
        <b id='depts' >{{ c.depts }} &euro;</b>
        {% else %}
        <b id='depts' ><font color='red'>{{ c.depts }} &euro;</font></b>
        {% endifequal %}
        </td>
        <td>
        <table>
            <tr id='buyrow{{ c.id }}' >
        {% for p in prices %}
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ c.name }}' id='customer{{ c.id }}_{{ p }}' />
            <input type='hidden' name='buy' value='{{ p }}' id='buy{{ c.id }}_{{ p }}' />
            <input type='submit' name='{{ p }}' value='{{ p }} ct' id='buybtn{{ c.id }}_{{ p }}' {% ifequal c.dept_status 2 %} disabled=true {% endifequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
            <script>
             $("#buybtn{{ c.id }}_{{ p }}").click(function() {
                buy("{{ c.name }}", "{{ p }}", true);
             return false;
             }); 
            </script>
        
        
        {% endfor %}
              </tr>
        </table>
        <td><form method='post' action='.'>
            <input type='text' name='money' id='paymoney{{ c.id }}' />
            <input type='hidden' name='customer' value='{{ c.name }}' />
            <input type='submit' name='pay' value='bezahlen' id='paybtn{{ c.id }}'
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
       <!-- <script>
         $("#paybtn{{ c.id }}").click(function() {
             buy("{{ c.name }}", $("#paymoney{{ c.id }}").val(), false);
             $("#paymoney{{ c.id }}").attr("value", "");
             return false;
             });  
        </script>-->
        </td>
        <td id='lastPaid{{ c.id }}'> {{ c.lastPaid.date|date:"D, d.M. Y" }}</td>
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ c.name }}' />
            <input type='submit' name='delete' value='delete' id='del{{ c.id }}' {% ifnotequal c.depts 0 %}disabled=true{% endifnotequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
    </tr>   
    
{% endfor %}
<tr>
<td colspan='6'><hr></td>
</tr>
<tr><td>
Summe
</td><td>
<b id='cSum' >{{ sum.1 }}</b>
</td>
</tr>
<tr><td>
Wochenumsatz
</td><td>
<b id='cSales' >{{ sum.0 }}</b>
</td>
</tr>
</table>
</div>
<br>
<table align='center' width='80%' style="font-size:65%;">
    <tr>
        <td> <a class='button' background='#4f4f4f' href='./register/'><span>Register new customer</span></a></td>
        <td> <a class='button' background='#4f4f4f' href='./transactions/'><span>Statistik</span></a></td>
        <td> <a class='button' background='#4f4f4f' href='./backup/'><span>Backup database</span></a></td>
    </tr>
</table>

</div>


{% endblock %}


