{% extends "basis.html" %}

{% block titel %}P&uuml;nte Schuldenliste{% endblock %}

{% block inhalt %}
<div id="content_container">

<font color='red' id='error' >{{ error }}</font>

<form method='post' action='.'>
    <input type='hidden' name='customer' value='{{ unname }}' id='unname' />
    <input type='hidden' name='unmoney' value='{{ unmoney }}' id='unmoney' />
    <input type='submit' name='undo' value='R&uuml;ckg&auml;ngig: {{ unname }} - {{ unmoney }}' id='undo'
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
</form>

<h2>P&uuml;ntenteam</h2>
<div id="content">
<table width='100%'>
<tr>
    <td>Name</td>
    <td>Schulden</td>
    <td>kaufen</td>
    <td>bezahlen</td>
    <td>zuletzt bezahlt</td>
</tr>

{% for pt in pmen %}
     <tr id='row{{ pt.id }}' >
        <td> <a href='{{ pt.id }}'>{{ pt.name }}</a></td>
        <td id="depts{{ pt.id }}">
         {% ifequal pt.dept_status 0 %} 
        <b>{{ pt.depts }}</b>
        {% else %}
        <b><font color='red'>{{ pt.depts }}</font></b>
        {% endifequal %}
        </td>
        <td>
        <table>
            <tr id='buyrow{{ pt.id }}' >
        {% for p in pprices %}
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ pt.name }}' id='customer{{ pt.id }}_{{ p }}' />
            <input type='hidden' name='buy' value='{{ p }}' id='buy{{ pt.id }}_{{ p }}' />
            <input type='submit' name='{{ p }}' id='buybtn{{ pt.id }}_{{ p }}' value='{{ p }} ct' {% ifequal pt.dept_status 2 %} disabled=true {% endifequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
        <script>
        var buy{{ pt.id}}_{{ p }} = function() {
            var customer = "{{ pt.name }}"
            var buy = "{{ p }}"
            var ajax = "yes";
            if (customer != "" && buy != "") {
                var data = { customer:customer, buy:buy, ajax:ajax };
                var args = { type:"POST", url:".", data:data, complete:done{{ pt.id}}_{{ p }} };
                $.ajax(args);
            }
            else {


            }
            return false;
            };
            
            var done{{ pt.id}}_{{ p }} = function(res, status) {
              if (status == "success") {

                var data = JSON.parse(res.responseText);
                if (data['status'] == '0' ) {
                    var newDepts = $("<td id='depts{{ pt.id }}'><b>"+data['depts']+'</b></td>');
                } else {
                    var newDepts = $("<td id='depts{{ pt.id }}'><b><font color='red'>"+data['depts']+'</font></b></td>');
                }
                if (data['status'] == '2' ) {
                    $("#buyrow{{ pt.id }} > * > * > input[type='submit']").attr("disabled", true);
                }
                $("#unname").attr("value", data['unname']);
                $("#unmoney").attr("value", data['unmoney']);
                $("#undo").attr("value", "R체ckg채ngig: "+data['unname']+" - "+data['unmoney']);
                $("#depts{{ pt.id }}").replaceWith(newDepts);
                $("#ptSum").replaceWith("<b id='ptSum' >"+data['ptSum']+"</b>");
                $("#ptSales").replaceWith("<b id='ptSales' >"+data['ptSales']+"</b>");
              }
              else {
                var elem = $('#row{{ pt.id }}');
                var msg_div = $('<tr><td colspan="6" ><font color="red"><p>No connection to server</p></font></td></tr>');
                msg_div.insertAfter(elem).fadeIn('slow').animate({opacity: 1.0}, 5000).fadeOut('slow',function() { msg_div.remove(); });
              }
            };
        $("#buybtn{{ pt.id }}_{{ p }}").click(buy{{ pt.id }}_{{ p }});
        </script>
        {% endfor %}
              </tr>
        </table>
        <td><form method='post' action='.'>
            <input type='text' name='money' />
            <input type='hidden' name='customer' value='{{ pt.name }}' />
            <input type='submit' name='pay' value='bezahlen' 
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>

        </td>
        <td> {{ pt.lastPaid.date|date:"D, d.M. Y" }}</td>
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ c.name }}' />
            <input type='submit' name='delete' value='delete' {% ifnotequal pt.depts 0 %}disabled=true{% endifnotequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
    </tr>   
    
{% endfor %}
<tr><td>
Summe
</td><td>
<b id='ptSum' >{{sum.3 }}</b>
</td>
</tr>
<tr><td>
Wochenumsatz
</td><td>
<b id='ptSales' >{{sum.2 }}</b>
</td>
</tr>

</table>
</div>
<h2>G&auml;ste</h2>
<div id="content">
<table width='100%'>
<tr>
    <td>Name</td>
    <td>Schulden</td>
    <td>kaufen</td>
    <td>bezahlen</td>
    <td>zuletzt bezahlt</td>
</tr>
{% for c in customer %}
     <tr id='row{{ c.id }}'>
        <td><a href='{{ c.id }}'>{{ c.name }}</a></td>
        <td id="depts{{ c.id }}" >
        {% ifequal c.dept_status 0 %} 
        <b id='depts' >{{ c.depts }}</b>
        {% else %}
        <b id='depts' ><font color='red'>{{ c.depts }}</font></b>
        {% endifequal %}
        </td>
        <td>
        <table>
            <tr id='buyrow{{ c.id }}' >
        {% for p in prices %}
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ c.name }}' id='customer{{ c.id }}_{{ p }}' />
            <input type='hidden' name='buy' value='{{ p }}' id='buy{{ c.id }}_{{ p }}' />
            <input type='submit' name='{{ p }}' value='{{ p }} ct' id='buybtn{{ c.id }}_{{ p }}' {% ifequal c.dept_status 2 %} disabled=true {% endifequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>

        <script>
        var buy{{ c.id}}_{{ p }} = function() {
            var customer = "{{ c.name }}"
            var buy = "{{ p }}"
            var ajax = "yes";
            if (customer != "" && buy != "") {
                var data = { customer:customer, buy:buy, ajax:ajax };
                var args = { type:"POST", url:".", data:data, complete:done{{ c.id}}_{{ p }} };
                $.ajax(args);
            }
            else {
                // bla
            }
            return false;
            };
            
            var done{{ c.id}}_{{ p }} = function(res, status) {
              if (status == "success") {

                var data = JSON.parse(res.responseText);
                if (data['status'] == '0' ) {
                    var newDepts = $("<td id='depts{{ c.id }}'><b>"+data['depts']+'</b></td>');
                } else {
                    var newDepts = $("<td id='depts{{ c.id }}'><b><font color='red'>"+data['depts']+'</font></b></td>');
                }
                if (data['status'] == '2' ) {
                    $("#buyrow{{ c.id }} > * > * > input[type='submit']").attr("disabled", true);
                }
                $("#unname").attr("value", data['unname']);
                $("#unmoney").attr("value", data['unmoney']);
                $("#undo").attr("value", "R체ckg채ngig: "+data['unname']+" - "+data['unmoney']);
                $("#depts{{ c.id }}").replaceWith(newDepts);
                $("#cSum").replaceWith("<b id='cSum' >"+data['cSum']+"</b>");
                $("#cSales").replaceWith("<b id='cSales' >"+data['cSales']+"</b>");
              }
              else {
                var elem = $('#row{{ c.id }}');
                var msg_div = $('<tr><td colspan="6" ><font color="red"><p>No connection to server</p></font></td></tr>');
                msg_div.insertAfter(elem).fadeIn('slow').animate({opacity: 1.0}, 5000).fadeOut('slow',function() { msg_div.remove(); });

              }
            };
        $("#buybtn{{ c.id }}_{{ p }}").click(buy{{ c.id }}_{{ p }});
        </script>
        
        
        {% endfor %}
              </tr>
        </table>
        <td><form method='post' action='.'>
            <input type='text' name='money' />
            <input type='hidden' name='customer' value='{{ c.name }}' />
            <input type='submit' name='pay' value='bezahlen'
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>

        </td>
        <td> {{ c.lastPaid.date|date:"D, d.M. Y" }}</td>
        <td><form method='post' action='.'>
            <input type='hidden' name='customer' value='{{ c.name }}' />
            <input type='submit' name='delete' value='delete' {% ifnotequal c.depts 0 %}disabled=true{% endifnotequal %}
                class='btn' onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'" />
        </form></td>
    </tr>   
    
{% endfor %}
<tr><td>
Summe
</td><td>
<b id='cSum' >{{ sum.1 }}</b>
</td>
</tr>
<tr><td>
Wochenumsatz
</td><td>
<b id='cSales' >{{ sum.0 }}</b>
</td>
</tr>
</table>
</div>
<br>
<table align='center'>
    <tr>
        <td> <a class='button' background='#4f4f4f' href='./register/'><span>Register</span></a> a new customer</td>
    </tr>
</table>

</div>


{% endblock %}


